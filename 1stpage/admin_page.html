<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Pro | Gulf Career Dashboard</title>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>

  <!-- Project Data -->
  <script>
    if (typeof visadata === 'undefined') window.visadata = [];
  </script>
  <script src="fisrtpagevisafiles/visa-data.js"></script>

  <style>
    :root {
      --primary: #0061ff;
      --primary-dark: #004ecc;
      --secondary: #1e293b;
      --success: #10b981;
      --danger: #ef4444;
      --bg: #f8fafc;
      --sidebar: #1e293b;
      --card-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.05);
      --font-main: 'Plus Jakarta Sans', sans-serif;
    }

    body {
      font-family: var(--font-main);
      background-color: var(--bg);
      margin: 0;
      display: flex;
      min-height: 100vh;
      color: #1e293b;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--sidebar);
      color: white;
      display: flex;
      flex-direction: column;
      padding: 30px 20px;
      position: fixed;
      height: 100vh;
    }

    .sidebar h2 {
      font-family: 'Outfit', sans-serif;
      font-size: 22px;
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-item {
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: 0.3s;
      color: #94a3b8;
      font-weight: 500;
    }

    .nav-item:hover,
    .nav-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    /* Main Content */
    .main-content {
      margin-left: 260px;
      flex: 1;
      padding: 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid #e2e8f0;
      animation: fadeInUp 0.5s ease backwards;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card:nth-child(2) {
      animation-delay: 0.1s;
    }

    .stat-card:nth-child(3) {
      animation-delay: 0.2s;
    }

    .stat-card:nth-child(4) {
      animation-delay: 0.3s;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(10px);
      }
    }

    .stat-card h3 {
      margin: 0;
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
    }

    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      margin: 10px 0;
      color: var(--secondary);
    }

    /* Scanner Box */
    .scanner-section {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
      border: 1px solid #e2e8f0;
    }

    .drop-zone {
      height: 180px;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      cursor: pointer;
      transition: 0.3s;
      position: relative;
    }

    .drop-zone:hover {
      border-color: var(--primary);
      background: #eff6ff;
    }

    .drop-zone i {
      font-size: 40px;
      color: var(--primary);
      margin-bottom: 10px;
    }

    /* Table Design */
    .table-card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f8fafc;
      padding: 15px 20px;
      text-align: left;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #64748b;
      border-bottom: 1px solid #e2e8f0;
    }

    td {
      padding: 15px 20px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 13px;
    }

    input[type="text"],
    input[type="date"],
    select {
      border: 1px solid #cbd5e1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      width: 100%;
      box-sizing: border-box;
      outline: none;
    }

    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 97, 255, 0.1);
    }

    /* Action Buttons */
    .btn {
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-outline {
      background: white;
      border: 1px solid #cbd5e1;
      color: #475569;
    }

    /* Loader */
    #loader {
      display: none;
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      align-items: center;
      justify-content: center;
      z-index: 100;
      border-radius: 12px;
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    /* Section visibility */
    .page-section {
      display: none;
    }

    .page-section.active-section {
      display: block;
    }

    /* Settings Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(6px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .settings-modal {
      background: white;
      border-radius: 20px;
      width: 560px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
      animation: modalSlide 0.35s ease;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      padding: 24px 28px 16px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      font-family: 'Outfit', sans-serif;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #64748b;
      transition: 0.2s;
    }

    .modal-close:hover {
      background: #fee2e2;
      color: #ef4444;
    }

    .modal-body {
      padding: 24px 28px;
    }

    .setting-group {
      margin-bottom: 24px;
    }

    .setting-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 8px;
    }

    .setting-group input[type="text"],
    .setting-group input[type="password"],
    .setting-group select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
      outline: none;
      transition: 0.2s;
    }

    .setting-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 97, 255, 0.1);
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .setting-row:last-child {
      border-bottom: none;
    }

    .setting-row .label-side h4 {
      margin: 0 0 2px;
      font-size: 14px;
      color: #1e293b;
    }

    .setting-row .label-side p {
      margin: 0;
      font-size: 12px;
      color: #94a3b8;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #cbd5e1;
      border-radius: 24px;
      cursor: pointer;
      transition: 0.3s;
    }

    .toggle-slider:before {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch input:checked+.toggle-slider {
      background: var(--primary);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(20px);
    }

    .modal-footer {
      padding: 16px 28px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Recent Activity */
    .activity-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px 20px;
      border-bottom: 1px solid #f1f5f9;
      transition: 0.2s;
    }

    .activity-item:hover {
      background: #f8fafc;
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .activity-icon.scan {
      background: #eff6ff;
      color: var(--primary);
    }

    .activity-icon.save {
      background: #ecfdf5;
      color: var(--success);
    }

    .activity-icon.delete {
      background: #fef2f2;
      color: var(--danger);
    }

    .activity-text h4 {
      margin: 0 0 3px;
      font-size: 14px;
    }

    .activity-text p {
      margin: 0;
      font-size: 12px;
      color: #94a3b8;
    }
  </style>
</head>

<body>

  <aside class="sidebar">
    <h2><i class="fas fa-shield-halved"></i> Admin Pro</h2>
    <div class="nav-item active" data-section="dashboard" onclick="switchSection('dashboard', this)"><i
        class="fas fa-chart-line"></i> Dashboard</div>
    <div class="nav-item" data-section="passports" onclick="switchSection('passports', this)"><i
        class="fas fa-passport"></i> Passports</div>
    <div class="nav-item" data-section="activity" onclick="switchSection('activity', this)"><i
        class="fas fa-history"></i> Recent Activity</div>
    <div class="nav-item" onclick="openSettings()"><i class="fas fa-gear"></i> Settings</div>
  </aside>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
    <div class="settings-modal">
      <div class="modal-header">
        <h2><i class="fas fa-gear" style="color: var(--primary); margin-right: 8px;"></i> Settings</h2>
        <button class="modal-close" onclick="closeSettings()"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="setting-group">
          <label><i class="fas fa-key" style="margin-right: 6px;"></i> Gemini API Key</label>
          <input type="password" id="settingGeminiKey" placeholder="Enter your Gemini API Key...">
        </div>
        <div class="setting-group">
          <label><i class="fas fa-server" style="margin-right: 6px;"></i> API Server Port</label>
          <input type="text" id="settingApiPort" placeholder="3000">
        </div>
        <div class="setting-group">
          <label><i class="fas fa-database" style="margin-right: 6px;"></i> Firebase Project ID</label>
          <input type="text" id="settingFirebaseProject" placeholder="visa-mofa-services">
        </div>

        <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 20px 0;">

        <div class="setting-row">
          <div class="label-side">
            <h4>Auto-Sync to Cloud</h4>
            <p>Automatically sync scanned data to Firestore</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleAutoSync" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="setting-row">
          <div class="label-side">
            <h4>Show Notifications</h4>
            <p>Display toast alerts for scan results</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleNotifications" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="setting-row">
          <div class="label-side">
            <h4>Dark Mode</h4>
            <p>Enable dark theme for the dashboard</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleDarkMode">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 20px 0;">

        <div class="setting-group">
          <label><i class="fas fa-download" style="margin-right: 6px;"></i> Export Data</label>
          <div style="display: flex; gap: 10px; margin-top: 4px;">
            <button class="btn btn-outline" onclick="exportTableCSV()" style="flex:1;"><i class="fas fa-file-csv"></i>
              Export CSV</button>
            <button class="btn btn-outline" onclick="exportTableJSON()" style="flex:1;"><i class="fas fa-file-code"></i>
              Export JSON</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-check"></i> Save Changes</button>
      </div>
    </div>
  </div>

  <main class="main-content">

    <!-- === DASHBOARD SECTION === -->
    <div id="section-dashboard" class="page-section active-section">
      <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div class="search-box" style="position: relative; width: 300px;">
          <i class="fas fa-search"
            style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
          <input type="text" id="tableSearch" placeholder="Search records..." style="padding-left: 45px;"
            onkeyup="filterTable()">
        </div>
        <div style="display: flex; gap: 15px;">
          <button class="btn btn-outline" onclick="location.reload()"><i class="fas fa-sync"></i> Refresh</button>
          <button class="btn btn-primary" onclick="saveAllRows()"><i class="fas fa-cloud-arrow-up"></i> Sync
            Cloud</button>
        </div>
      </header>

      <section class="stats-grid">
        <div class="stat-card">
          <h3>Total Visas</h3>
          <div class="value">1,280</div>
        </div>
        <div class="stat-card">
          <h3>Scanned Today</h3>
          <div class="value">45</div>
        </div>
        <div class="stat-card">
          <h3>Success Rate</h3>
          <div class="value">98.2%</div>
        </div>
        <div class="stat-card">
          <h3>API Status</h3>
          <div class="value" style="color: var(--success); font-size: 16px;">ONLINE <i class="fas fa-circle-check"></i>
          </div>
        </div>
      </section>

      <section class="scanner-section">
        <h3 style="margin-top:0;"><i class="fas fa-expand"></i> Global AI OCR Scanner</h3>
        <div class="drop-zone" onclick="document.getElementById('passportInput').click()">
          <div id="loader">
            <i class="fas fa-circle-notch spin" style="font-size: 30px; color: var(--primary);"></i>
            <b style="margin-left: 15px;">Extracting Data via AI...</b>
          </div>
          <i class="fas fa-camera-retro"></i>
          <p>Upload Passport Image (JPG/PNG)</p>
          <span style="font-size: 12px; color: #94a3b8;">Supports MRZ / Automated Field Mapping</span>
          <input type="file" id="passportInput" hidden accept="image/*" onchange="runAiScan(this)">
        </div>
        <div style="margin-top: 15px;">
          <button class="btn btn-primary" onclick="addNewEmptyRow()"><i class="fas fa-plus"></i> Manual Add Row</button>
        </div>
      </section>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th width="50">Photo</th>
              <th>Full Name</th>
              <th>Passport No</th>
              <th>App No</th>
              <th>Visa No</th>
              <th>Nationality</th>
              <th>Stay</th>
              <th>Expiry</th>
              <th>Reference</th>
              <th>POB</th>
              <th>POI</th>
              <th width="100">Actions</th>
            </tr>
          </thead>
          <tbody id="masterTable"></tbody>
        </table>
      </div>
    </div>

    <!-- === PASSPORTS SECTION === -->
    <div id="section-passports" class="page-section">
      <header style="margin-bottom: 25px;">
        <h2 style="font-family: 'Outfit', sans-serif; margin: 0 0 6px;"><i class="fas fa-passport"
            style="color: var(--primary); margin-right: 8px;"></i> Passports Database</h2>
        <p style="margin: 0; color: #64748b; font-size: 14px;">All passports synced from Firestore</p>
      </header>
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Full Name</th>
              <th>Passport No</th>
              <th>Nationality</th>
              <th>Date of Birth</th>
              <th>Expiry Date</th>
              <th>Place of Issue</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="passportsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- === RECENT ACTIVITY SECTION === -->
    <div id="section-activity" class="page-section">
      <header style="margin-bottom: 25px;">
        <h2 style="font-family: 'Outfit', sans-serif; margin: 0 0 6px;"><i class="fas fa-history"
            style="color: var(--primary); margin-right: 8px;"></i> Recent Activity</h2>
        <p style="margin: 0; color: #64748b; font-size: 14px;">Latest actions and events</p>
      </header>
      <div class="table-card" style="padding: 0;">
        <ul class="activity-list" id="activityList">
          <!-- Populated by JS -->
        </ul>
      </div>
    </div>

  </main>

  <script>
    let API_PORT = localStorage.getItem('settingApiPort') || 3000;
    const firebaseConfig = {
      apiKey: "AIzaSyCUJtSGtLJHA-x8ITjHMVRVCi1mLYeqO9s",
      authDomain: "visa-mofa-services.firebaseapp.com",
      projectId: localStorage.getItem('settingFirebaseProject') || "visa-mofa-services",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let visaAuto = 4056712390;
    let refAuto = 89901235;
    const activityLog = [];

    function logActivity(type, message) {
      activityLog.unshift({ type, message, time: new Date() });
      renderActivity();
    }

    function renderActivity() {
      const list = document.getElementById('activityList');
      if (!list) return;
      list.innerHTML = activityLog.slice(0, 30).map(a => {
        const iconClass = a.type === 'scan' ? 'scan' : a.type === 'save' ? 'save' : 'delete';
        const icon = a.type === 'scan' ? 'fa-expand' : a.type === 'save' ? 'fa-cloud-arrow-up' : 'fa-trash';
        const ago = timeSince(a.time);
        return `<li class="activity-item">
          <div class="activity-icon ${iconClass}"><i class="fas ${icon}"></i></div>
          <div class="activity-text"><h4>${a.message}</h4><p>${ago}</p></div>
        </li>`;
      }).join('');
      if (activityLog.length === 0) {
        list.innerHTML = '<li class="activity-item" style="justify-content:center; color:#94a3b8;">No activity yet</li>';
      }
    }

    function timeSince(date) {
      const s = Math.floor((new Date() - date) / 1000);
      if (s < 5) return 'Just now';
      if (s < 60) return s + 's ago';
      if (s < 3600) return Math.floor(s / 60) + 'm ago';
      return Math.floor(s / 3600) + 'h ago';
    }

    // --- Sidebar Navigation ---
    function switchSection(sectionId, navEl) {
      document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section'));
      document.getElementById('section-' + sectionId).classList.add('active-section');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      if (navEl) navEl.classList.add('active');
      if (sectionId === 'passports') loadPassports();
      if (sectionId === 'activity') renderActivity();
    }

    // --- Settings Modal ---
    function openSettings() {
      document.getElementById('settingsOverlay').classList.add('open');
      document.getElementById('settingApiPort').value = API_PORT;
      document.getElementById('settingFirebaseProject').value = firebaseConfig.projectId;
      document.getElementById('settingGeminiKey').value = localStorage.getItem('geminiKey') || '';
      document.getElementById('toggleAutoSync').checked = localStorage.getItem('autoSync') !== 'false';
      document.getElementById('toggleNotifications').checked = localStorage.getItem('notifications') !== 'false';
    }
    function closeSettings() {
      document.getElementById('settingsOverlay').classList.remove('open');
    }
    function saveSettings() {
      API_PORT = document.getElementById('settingApiPort').value || 3000;
      localStorage.setItem('settingApiPort', API_PORT);
      localStorage.setItem('settingFirebaseProject', document.getElementById('settingFirebaseProject').value);
      localStorage.setItem('geminiKey', document.getElementById('settingGeminiKey').value);
      localStorage.setItem('autoSync', document.getElementById('toggleAutoSync').checked);
      localStorage.setItem('notifications', document.getElementById('toggleNotifications').checked);
      showToast('Settings saved!', 'success');
      closeSettings();
    }

    // --- Export Functions ---
    function exportTableCSV() {
      const rows = document.querySelectorAll('#masterTable tr');
      let csv = 'Name,Passport,AppNo,VisaNo,Nationality,Stay,Expiry,Ref,POB,POI\n';
      rows.forEach(r => {
        const cells = r.querySelectorAll('input');
        csv += Array.from(cells).map(c => '"' + c.value + '"').join(',') + '\n';
      });
      downloadBlob(csv, 'visa_export.csv', 'text/csv');
      showToast('CSV exported!', 'success');
    }
    function exportTableJSON() {
      const rows = document.querySelectorAll('#masterTable tr');
      const data = [];
      rows.forEach(r => {
        data.push({
          Name: r.querySelector('.i-name')?.value,
          Passport_No: r.querySelector('.i-pass')?.value,
          Application_No: r.querySelector('.i-app')?.value,
          Visa_no: r.querySelector('.i-visa')?.value,
          Nationality: r.querySelector('.i-nat')?.value,
          validy_days: r.querySelector('.i-stay')?.value,
          PssEXpDate: r.querySelector('.i-exp')?.value,
          Ref_no: r.querySelector('.i-ref')?.value,
          placeOfBirth: r.querySelector('.i-pob')?.value,
          placeOfIssue: r.querySelector('.i-poi')?.value,
        });
      });
      downloadBlob(JSON.stringify(data, null, 2), 'visa_export.json', 'application/json');
      showToast('JSON exported!', 'success');
    }
    function downloadBlob(content, filename, type) {
      const blob = new Blob([content], { type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    // --- Passports Loader ---
    async function loadPassports() {
      const tbody = document.getElementById('passportsTable');
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#94a3b8;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
      try {
        const snap = await db.collection('visa').get();
        if (snap.empty) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#94a3b8;">No passports found</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        snap.forEach(doc => {
          const d = doc.data();
          const isExpired = d.PssEXpDate && new Date(d.PssEXpDate) < new Date();
          tbody.innerHTML += `<tr>
            <td><img src="${d.imagesrc || ''}" style="width:40px;height:40px;border-radius:6px;background:#eee;"></td>
            <td>${d.Name || '-'}</td>
            <td><b>${d.Passport_No || '-'}</b></td>
            <td>${d.Nationality || '-'}</td>
            <td>${d.Birth_Date || '-'}</td>
            <td>${d.PssEXpDate || '-'}</td>
            <td>${d.placeOfIssue || '-'}</td>
            <td><span style="padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;background:${isExpired ? '#fef2f2' : '#ecfdf5'};color:${isExpired ? '#ef4444' : '#10b981'};">${isExpired ? 'Expired' : 'Active'}</span></td>
          </tr>`;
        });
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#ef4444;">Error loading data</td></tr>';
      }
    }

    // Boot
    window.onload = async () => {
      visadata.forEach(d => injectRow(d));
      updateStats();
      renderActivity();
      logActivity('scan', 'Dashboard loaded');
    };

    async function updateStats() {
      try {
        const snap = await db.collection("visa").get();
        document.querySelector('.stat-card:nth-child(1) .value').innerText = snap.size;

        // Mocking others for now or count today's
        const today = new Date().toISOString().split('T')[0];
        const scannedToday = snap.docs.filter(doc => doc.data().createdAt?.startsWith(today)).length;
        document.querySelector('.stat-card:nth-child(2) .value').innerText = scannedToday;
      } catch (err) {
        console.error("Stats Error:", err);
      }
    }

    function injectRow(data = {}) {
      const tbody = document.getElementById('masterTable');
      const row = document.createElement('tr');

      visaAuto++;
      refAuto++;

      row.innerHTML = `
                <td><img src="${data.imagesrc || ''}" style="width: 40px; height: 40px; border-radius: 6px; background: #eee;"></td>
                <td><input type="text" class="i-name" value="${data.Name || ''}" placeholder="Full Name"></td>
                <td><input type="text" class="i-pass" value="${data.Passport_No || ''}" placeholder="Passport No" maxlength="9"></td>
                <td><input type="text" class="i-app" value="${data.Application_No || 'E' + Math.random().toString().slice(-6)}" placeholder="App No"></td>
                <td><input type="text" class="i-visa" value="${data.Visa_no || visaAuto}" placeholder="Visa No"></td>
                <td><input type="text" class="i-nat" value="${data.Nationality || 'INDIA'}" placeholder="Nationality"></td>
                <td><input type="text" class="i-stay" value="${data.validy_days || '90'}" placeholder="Stay"></td>
                <td><input type="date" class="i-exp" value="${data.PssEXpDate || ''}"></td>
                <td><input type="text" class="i-ref" value="${data.Ref_no || refAuto}"></td>
                <td><input type="text" class="i-pob" value="${data.placeOfBirth || ''}" placeholder="POB"></td>
                <td><input type="text" class="i-poi" value="${data.placeOfIssue || ''}" placeholder="POI"></td>
                <td>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-primary btn-save" style="padding: 6px 10px;" onclick="saveSingle(this)"><i class="fas fa-check"></i></button>
                        <button class="btn btn-outline" style="padding: 6px 10px; color: var(--danger);" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            `;
      tbody.prepend(row);
    }

    function addNewEmptyRow() {
      injectRow({});
    }

    async function runAiScan(input) {
      if (!input.files[0]) return;
      const loader = document.getElementById('loader');
      loader.style.display = 'flex';

      const reader = new FileReader();
      reader.onload = async (e) => {
        const imgBase64 = e.target.result;
        try {
          const res = await fetch(`http://localhost:${API_PORT}/api/scan-passport`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imgBase64 })
          });

          if (!res.ok) throw new Error("Server error");

          const aiData = await res.json();
          aiData.imagesrc = imgBase64;
          injectRow(aiData);
          showToast("AI Scanning Successful!", "success");
          logActivity('scan', 'Passport scanned: ' + (aiData.Name || 'Unknown'));

        } catch (err) {
          console.error(err);
          showToast("Scan failed. Check if server.js is running.", "error");
        } finally {
          loader.style.display = 'none';
          input.value = '';
        }
      };
      reader.readAsDataURL(input.files[0]);
    }

    async function saveSingle(btn) {
      const row = btn.closest('tr');
      const data = {
        Name: row.querySelector('.i-name').value,
        Passport_No: row.querySelector('.i-pass').value,
        Application_No: row.querySelector('.i-app').value,
        Visa_no: row.querySelector('.i-visa').value,
        Nationality: row.querySelector('.i-nat').value,
        validy_days: row.querySelector('.i-stay').value,
        PssEXpDate: row.querySelector('.i-exp').value,
        Ref_no: row.querySelector('.i-ref').value,
        placeOfBirth: row.querySelector('.i-pob').value,
        placeOfIssue: row.querySelector('.i-poi').value,
        imagesrc: row.querySelector('img').src,
        createdAt: new Date().toISOString()
      };

      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        await db.collection("visa").doc(data.Application_No).set(data);
        showToast("Data saved to Cloud!", "success");
        btn.innerHTML = '<i class="fas fa-check"></i>';
        logActivity('save', 'Saved: ' + data.Name);
        updateStats(); // Refresh stats
      } catch (err) {
        console.error(err);
        showToast("Cloud sync failed!", "error");
        btn.innerHTML = '<i class="fas fa-check"></i>';
      } finally {
        btn.disabled = false;
      }
    }

    function filterTable() {
      const query = document.getElementById('tableSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#masterTable tr');
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
      });
    }

    async function saveAllRows() {
      const rows = document.querySelectorAll('#masterTable tr');
      const buttons = document.querySelectorAll('.btn-save');

      showToast(`Syncing ${rows.length} rows...`, "success");

      for (let btn of buttons) {
        await saveSingle(btn);
      }

      showToast("Batch Sync Complete!", "success");
    }

    function showToast(msg, type) {
      const toast = document.createElement('div');
      toast.style = `position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; background: ${type === 'success' ? '#10b981' : '#ef4444'}; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-weight: 600; animation: slideIn 0.3s ease;`;
      toast.innerText = msg;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }
  </script>
</body>

</html>
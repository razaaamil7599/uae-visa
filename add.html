<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Candidate | AL-HARAM PORTAL</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCUJtSGtLJHA-x8ITjHMVRVCi1mLYeqO9s",
      authDomain: "visa-mofa-services.firebaseapp.com",
      projectId: "visa-mofa-services",
      storageBucket: "visa-mofa-services.appspot.com",
      messagingSenderId: "649801466644",
      appId: "1:649801466644:web:863d1cf2cb6a00fc583801"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <div class="container">
    <div class="page-title">Register New Candidate</div>

    <form id="registerForm" onsubmit="return false;">
      <div style="display: flex; justify-content: flex-end; padding: 10px 20px;">
        <div class="lang-toggle-container">
          <button type="button" class="lang-btn active" id="btn-en">English</button>
          <button type="button" class="lang-btn" id="btn-ar">العربية</button>
        </div>
      </div>

      <!-- Search By Section -->
      <div class="form-section">
        <span class="section-label">Search By</span>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="searchBy" value="file" checked> File No.
          </label>
          <label class="radio-option">
            <input type="radio" name="searchBy" value="passport"> Passport Information
          </label>
        </div>

        <div class="radio-group" style="margin-top: 15px;">
          <span style="font-size: 0.9rem; color: #666; width: 100px;">Select Type</span>
          <label class="radio-option">
            <input type="radio" name="type" value="Residency" checked onchange="updateFormMode()"> Residency
          </label>
          <label class="radio-option">
            <input type="radio" name="type" value="Visa" onchange="updateFormMode()"> Visa
          </label>
          <label class="radio-option">
            <input type="radio" name="type" value="Emirates ID" onchange="updateFormMode()"> Emirates ID
          </label>
        </div>
      </div>

      <!-- File Details Section -->
      <div class="form-section">
        <span class="section-label">File Details</span>
        <div class="grid-2">
          <!-- Single File Input -->
          <div class="input-wrapper" id="singleFileWrapper">
            <label class="input-label" id="lblFile">File Number *</label>
            <input name="fileNumber" placeholder="File Number">
          </div>

          <!-- 4-Part File Input -->
          <div class="input-wrapper" id="multiFileWrapper" style="display: none; grid-column: span 2;">
            <label class="input-label">File Number (Dept/Year/Type/Seq) *</label>
            <div class="grid-4">
              <div class="multi-input">
                <input name="fileDept" placeholder="Dept">
                <span class="slash">/</span>
              </div>
              <div class="multi-input">
                <input name="fileYear" placeholder="Year">
                <span class="slash">/</span>
              </div>
              <div class="multi-input">
                <input name="fileTypePart" placeholder="Type">
                <span class="slash">/</span>
              </div>
              <input name="fileSeq" placeholder="Seq">
            </div>
          </div>

          <div class="input-wrapper">
            <label class="input-label" id="lblPassport">Passport Number *</label>
            <input name="passport" placeholder="Passport Number" required>
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblPassportExpiry">Passport Expiry Date *</label>
            <input name="passportExpiry" type="date" required>
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblVisa">Visa Number</label>
            <input name="visa" placeholder="Visa Number">
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblUnified">Emirate Unified Number *</label>
            <input name="unifiedNumber" placeholder="Unified Number" required>
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblNationality">Nationality *</label>
            <div class="nationality-wrapper">
              <input class="nat-code" id="natCode" placeholder='' oninput="syncFromCode()">
              <div class="nat-search-wrapper">
                <input class="nat-search" id="natSearch" name="nationality" placeholder="Please Select"
                  onfocus="showNatList()" oninput="filterNatList()" required>
                <div class="search-dropdown" id="natDropdown"></div>
              </div>
            </div>
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblDob">Date of Birth *</label>
            <input name="dob" type="date" required>
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblStatus">File Status</label>
            <select name="fileStatus">
              <option value="USED">USED</option>
              <option value="ACTIVE">ACTIVE</option>
              <option value="EXPIRED">EXPIRED</option>
            </select>
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblIssuance">File Issuance Date</label>
            <input name="issuanceDate" type="date">
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblExpiry">File Expiry Date</label>
            <input name="expiryDate" type="date">
          </div>
          <div class="input-wrapper">
            <label class="input-label" id="lblLeaving">Last Date of Leaving</label>
            <input name="lastLeavingDate" type="date">
          </div>
        </div>
        <div class="input-wrapper" style="margin-top: 10px;">
          <label class="input-label" id="lblPhoto">Candidate Photo (JPG/PDF) *</label>
          <input type="file" name="photo" required>
        </div>
      </div>

      <div class="search-footer">
        <button type="submit" class="btn-search" id="btnAdd">Add Candidate</button>
        <a href="/"
          style="text-decoration:none; padding:8px 20px; border:1px solid #ccc; border-radius:4px; color:#666; font-size:0.9rem">Cancel</a>
      </div>
    </form>
  </div>

  <script>
    const nationalities = [
      { code: '205', name: 'INDIA' },
      { code: '201', name: 'PAKISTAN' },
      { code: '202', name: 'BANGLADESH' },
      { code: '210', name: 'UAE' },
      { code: '215', name: 'EGYPT' },
      { code: '220', name: 'HAITI' },
      { code: '225', name: 'HOLY SEE (VATICAN)' },
      { code: '230', name: 'HONDURAS' }
    ];

    function showNatList() {
      const dropdown = document.getElementById('natDropdown');
      dropdown.style.display = 'block';
      renderNatList(nationalities);
    }

    function renderNatList(list) {
      const dropdown = document.getElementById('natDropdown');
      dropdown.innerHTML = '';
      list.forEach(item => {
        const div = document.createElement('div');
        div.textContent = item.name;
        div.onclick = () => selectNat(item);
        dropdown.appendChild(div);
      });
    }

    function filterNatList() {
      const query = document.getElementById('natSearch').value.toUpperCase();
      const filtered = nationalities.filter(item => item.name.includes(query));
      renderNatList(filtered);
    }

    function selectNat(item) {
      document.getElementById('natCode').value = item.code;
      document.getElementById('natSearch').value = item.name;
      document.getElementById('natDropdown').style.display = 'none';
    }

    function syncFromCode() {
      const code = document.getElementById('natCode').value.trim();
      if (!code) {
        document.getElementById('natSearch').value = "";
        return;
      }
      const item = nationalities.find(n => n.code === code);
      if (item) {
        document.getElementById('natSearch').value = item.name;
      } else {
        document.getElementById('natSearch').value = "";
      }
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.nationality-wrapper')) {
        document.getElementById('natDropdown').style.display = 'none';
      }
    });

    function updateFormMode() {
      const type = document.querySelector('input[name="type"]:checked').value;
      const single = document.getElementById('singleFileWrapper');
      const multi = document.getElementById('multiFileWrapper');

      if (type === 'Visa') {
        single.style.display = 'none';
        multi.style.display = 'block';
      } else {
        single.style.display = 'block';
        multi.style.display = 'none';
      }
    }

    // Convert file to Base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
      });
    }

    // Add Candidate to Firestore
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = document.getElementById('registerForm');
      const btn = document.getElementById('btnAdd');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const type = document.querySelector('input[name="type"]:checked').value;
        const photoFile = form.querySelector('input[name="photo"]').files[0];
        let photoBase64 = '';
        if (photoFile) {
          photoBase64 = await fileToBase64(photoFile);
        }

        const data = {
          type: type,
          passport: form.querySelector('input[name="passport"]').value,
          passportExpiry: form.querySelector('input[name="passportExpiry"]').value,
          visa: form.querySelector('input[name="visa"]').value,
          unifiedNumber: form.querySelector('input[name="unifiedNumber"]').value,
          nationality: form.querySelector('input[name="nationality"]').value,
          natCode: document.getElementById('natCode').value,
          dob: form.querySelector('input[name="dob"]').value,
          fileStatus: form.querySelector('select[name="fileStatus"]').value,
          issuanceDate: form.querySelector('input[name="issuanceDate"]').value,
          expiryDate: form.querySelector('input[name="expiryDate"]').value,
          lastLeavingDate: form.querySelector('input[name="lastLeavingDate"]').value,
          photo: photoBase64,
          photoName: photoFile ? photoFile.name : '',
          createdAt: new Date().toISOString()
        };

        if (type === 'Visa') {
          data.fileDept = form.querySelector('input[name="fileDept"]').value;
          data.fileYear = form.querySelector('input[name="fileYear"]').value;
          data.fileTypePart = form.querySelector('input[name="fileTypePart"]').value;
          data.fileSeq = form.querySelector('input[name="fileSeq"]').value;
        } else {
          data.fileNumber = form.querySelector('input[name="fileNumber"]').value;
        }

        await db.collection('candidates').add(data);
        alert('✅ Candidate added successfully!');
        form.reset();
      } catch (err) {
        console.error(err);
        alert('❌ Error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add Candidate';
      }
    });

    const btnEn = document.getElementById('btn-en');
    const btnAr = document.getElementById('btn-ar');
    const form = document.getElementById('registerForm');

    const translation = {
      en: {
        title: "Register New Candidate",
        file: "File Number *",
        passport: "Passport Number *",
        passportExpiry: "Passport Expiry Date *",
        visa: "Visa Number",
        unified: "Emirate Unified Number *",
        nationality: "Nationality *",
        dob: "Date of Birth *",
        photo: "Candidate Photo (JPG/PDF) *",
        add: "Add Candidate"
      },
      ar: {
        title: "تسجيل مرشح جديد",
        file: "رقم الملف *",
        passport: "رقم جواز السفر *",
        passportExpiry: "تاريخ انتهاء جواز السفر *",
        visa: "رقم التأشيرة",
        unified: "الرقم الموحد للإمارات *",
        nationality: "الجنسية *",
        dob: "تاريخ الميلاد *",
        photo: "صورة المرشح (JPG/PDF) *",
        add: "إضافة مرشح"
      }
    };

    function setLanguage(lang) {
      const isAr = lang === 'ar';
      btnAr.classList.toggle('active', isAr);
      btnEn.classList.toggle('active', !isAr);
      form.classList.toggle('rtl', isAr);

      document.querySelector('.page-title').textContent = translation[lang].title;
      document.getElementById('lblFile').textContent = translation[lang].file;
      document.getElementById('lblPassport').textContent = translation[lang].passport;
      document.getElementById('lblPassportExpiry').textContent = translation[lang].passportExpiry;
      document.getElementById('lblVisa').textContent = translation[lang].visa;
      document.getElementById('lblUnified').textContent = translation[lang].unified;
      document.getElementById('lblNationality').textContent = translation[lang].nationality;
      document.getElementById('lblDob').textContent = translation[lang].dob;
      document.getElementById('lblPhoto').textContent = translation[lang].photo;
      document.getElementById('btnAdd').textContent = translation[lang].add;

      form.querySelectorAll('input:not([type="file"]):not([type="date"])').forEach(input => {
        if (input.name === 'nationality') return;
        input.placeholder = translation[lang][input.name] || input.placeholder;
      });
    }

    btnEn.addEventListener('click', () => setLanguage('en'));
    btnAr.addEventListener('click', () => setLanguage('ar'));

    updateFormMode();
  </script>
</body>

</html>